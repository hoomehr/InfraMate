name: Security Scan

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Target repository to scan'
        required: true
        default: '.'
      target_branch:
        description: 'Branch to scan'
        required: true
        default: 'main'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Inframate
        uses: actions/checkout@v4
        with:
          path: inframate
          
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.target_repo }}
          ref: ${{ github.event.inputs.target_branch }}
          path: target_repo
      
      - name: Find Terraform files
        id: find_tf
        run: |
          cd target_repo
          echo "Scanning for Terraform files..."
          TF_FILES=$(find . -name "*.tf" | sort)
          
          if [ -z "$TF_FILES" ]; then
            echo "No Terraform files found in the repository."
            echo "tf_found=false" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "Found Terraform files:"
            echo "$TF_FILES"
            echo "tf_found=true" >> $GITHUB_OUTPUT
            
            # Find the main Terraform directory
            MAIN_TF_DIR=$(dirname $(find . -name "*.tf" | sort) | sort | uniq -c | sort -nr | head -1 | awk '{print $2}')
            echo "main_tf_dir=$MAIN_TF_DIR" >> $GITHUB_OUTPUT
          fi
      
      - name: Set up security scanning tools
        if: steps.find_tf.outputs.tf_found == 'true'
        run: |
          # Install TFSec
          wget -q -O tfsec https://github.com/aquasecurity/tfsec/releases/download/v1.28.1/tfsec-linux-amd64
          chmod +x tfsec
          sudo mv tfsec /usr/local/bin/
          tfsec --version
          
          # Install Checkov
          pip install checkov
          checkov --version
          
          # Copy security scripts
          mkdir -p scripts
          cp inframate/scripts/security/*.py scripts/
      
      - name: Run TFSec Security Scan
        if: steps.find_tf.outputs.tf_found == 'true'
        id: tfsec
        run: |
          cd target_repo
          MAIN_TF_DIR=$(cat $GITHUB_OUTPUT | grep main_tf_dir | cut -d= -f2)
          
          echo "Scanning directory: $MAIN_TF_DIR"
          mkdir -p security_reports
          
          # Run TFSec
          if [ -d "$MAIN_TF_DIR" ]; then
            tfsec "$MAIN_TF_DIR" --format json > security_reports/tfsec_report.json || true
            tfsec "$MAIN_TF_DIR" --format markdown > security_reports/tfsec_report.md || true
          else
            tfsec . --format json > security_reports/tfsec_report.json || true
            tfsec . --format markdown > security_reports/tfsec_report.md || true
          fi
          
          # Create summary
          ISSUE_COUNT=$(cat security_reports/tfsec_report.json | grep -o '"results":\[[^]]*\]' | grep -o 'severity' | wc -l)
          echo "tfsec_issues=$ISSUE_COUNT" >> $GITHUB_OUTPUT
          
          # Generate HTML report
          python3 ../scripts/tfsec_parser.py --json security_reports/tfsec_report.json --html security_reports/tfsec_report.html
          
          echo "TFSec scan completed. Found $ISSUE_COUNT issues."
      
      - name: Run Checkov Security Scan
        if: steps.find_tf.outputs.tf_found == 'true'
        id: checkov
        run: |
          cd target_repo
          MAIN_TF_DIR=$(cat $GITHUB_OUTPUT | grep main_tf_dir | cut -d= -f2)
          
          echo "Scanning directory: $MAIN_TF_DIR"
          mkdir -p security_reports
          
          # Run Checkov
          if [ -d "$MAIN_TF_DIR" ]; then
            checkov -d "$MAIN_TF_DIR" -o json > security_reports/checkov_report.json || true
            checkov -d "$MAIN_TF_DIR" -o cli > security_reports/checkov_report.txt || true
          else
            checkov -d . -o json > security_reports/checkov_report.json || true
            checkov -d . -o cli > security_reports/checkov_report.txt || true
          fi
          
          # Create summary
          FAILED_CHECKS=$(cat security_reports/checkov_report.json | grep -o '"check_id"' | wc -l)
          echo "checkov_issues=$FAILED_CHECKS" >> $GITHUB_OUTPUT
          
          # Generate HTML report
          python3 ../scripts/checkov_parser.py --json security_reports/checkov_report.json --html security_reports/checkov_report.html
          
          echo "Checkov scan completed. Found $FAILED_CHECKS issues."

      - name: Create Security Report
        if: steps.find_tf.outputs.tf_found == 'true'
        run: |
          cd target_repo
          MAIN_TF_DIR=$(cat $GITHUB_OUTPUT | grep main_tf_dir | cut -d= -f2)
          TFSEC_ISSUES=$(cat $GITHUB_OUTPUT | grep tfsec_issues | cut -d= -f2 || echo "0")
          CHECKOV_ISSUES=$(cat $GITHUB_OUTPUT | grep checkov_issues | cut -d= -f2 || echo "0")
          TOTAL_ISSUES=$((TFSEC_ISSUES + CHECKOV_ISSUES))
          
          # Create basic report
          echo "# Security Scan Report" > security_reports/SECURITY_REPORT.md
          echo "" >> security_reports/SECURITY_REPORT.md
          echo "## Summary" >> security_reports/SECURITY_REPORT.md
          echo "- **Total Issues Found**: ${TOTAL_ISSUES}" >> security_reports/SECURITY_REPORT.md
          echo "- **TFSec Issues**: ${TFSEC_ISSUES}" >> security_reports/SECURITY_REPORT.md
          echo "- **Checkov Issues**: ${CHECKOV_ISSUES}" >> security_reports/SECURITY_REPORT.md
          echo "" >> security_reports/SECURITY_REPORT.md
          echo "## Detailed Reports" >> security_reports/SECURITY_REPORT.md
          echo "- [TFSec Report](tfsec_report.md)" >> security_reports/SECURITY_REPORT.md
          echo "- [Checkov Report](checkov_report.txt)" >> security_reports/SECURITY_REPORT.md
          echo "" >> security_reports/SECURITY_REPORT.md
          echo "## Recommendations" >> security_reports/SECURITY_REPORT.md
          
          # Add recommendations based on common findings
          if [ $TOTAL_ISSUES -gt 0 ]; then
            echo "### General Security Recommendations" >> security_reports/SECURITY_REPORT.md
            echo "- Encrypt sensitive data at rest and in transit" >> security_reports/SECURITY_REPORT.md
            echo "- Use IAM roles with least privilege access" >> security_reports/SECURITY_REPORT.md
            echo "- Enable logging and monitoring for all resources" >> security_reports/SECURITY_REPORT.md
            echo "- Implement network security groups with restrictive rules" >> security_reports/SECURITY_REPORT.md
            echo "- Use secure defaults for all resources" >> security_reports/SECURITY_REPORT.md
            echo "" >> security_reports/SECURITY_REPORT.md
            echo "### Common Issues to Fix" >> security_reports/SECURITY_REPORT.md
            
            # Extract common issues from TFSec
            if [ $TFSEC_ISSUES -gt 0 ]; then
              echo "#### TFSec Findings" >> security_reports/SECURITY_REPORT.md
              cat security_reports/tfsec_report.md | grep -o '\*\*Description\*\*: .*' | sed 's/\*\*Description\*\*: /- /' | sort | uniq | head -10 >> security_reports/SECURITY_REPORT.md
            fi
            
            # Extract common issues from Checkov
            if [ $CHECKOV_ISSUES -gt 0 ]; then
              echo "#### Checkov Findings" >> security_reports/SECURITY_REPORT.md
              cat security_reports/checkov_report.txt | grep 'Check:' | sed 's/Check: /- /' | sort | uniq | head -10 >> security_reports/SECURITY_REPORT.md
            fi
          else
            echo "ðŸŽ‰ No security issues found! Keep up the good work!" >> security_reports/SECURITY_REPORT.md
            echo "" >> security_reports/SECURITY_REPORT.md
            echo "### Proactive Security Recommendations" >> security_reports/SECURITY_REPORT.md
            echo "- Regularly update your providers and modules" >> security_reports/SECURITY_REPORT.md
            echo "- Implement infrastructure security scanning in your CI/CD pipeline" >> security_reports/SECURITY_REPORT.md
            echo "- Review IAM permissions regularly and follow least privilege principle" >> security_reports/SECURITY_REPORT.md
            echo "- Enable encryption and logging across all services" >> security_reports/SECURITY_REPORT.md
            echo "- Use Terraform modules from trusted sources" >> security_reports/SECURITY_REPORT.md
          fi
          
          # Copy report to the main directory if it's not the same as the current directory
          if [ "$MAIN_TF_DIR" != "." ] && [ -d "$MAIN_TF_DIR" ]; then
            mkdir -p "${MAIN_TF_DIR}/security"
            cp -r security_reports/* "${MAIN_TF_DIR}/security/"
          fi
          
          echo "Security report generated."
      
      - name: Generate AI Security Analysis
        if: steps.find_tf.outputs.tf_found == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # Install required packages
          pip install google-generativeai python-dotenv
          
          cd target_repo
          
          # Check if reports exist
          if [ ! -f "security_reports/tfsec_report.md" ] || [ ! -f "security_reports/checkov_report.txt" ]; then
            echo "Warning: Security reports not found. Cannot generate AI analysis."
            touch security_reports/AI_SECURITY_ANALYSIS.md
            echo "# Security Analysis Unavailable\n\nUnable to generate AI security analysis due to missing security reports." > security_reports/AI_SECURITY_ANALYSIS.md
            exit 0
          fi
          
          # Create a simple text file with all findings for Gemini
          echo "# TFSec Findings" > security_reports/all_findings.txt
          cat security_reports/tfsec_report.md >> security_reports/all_findings.txt
          echo "\n\n# Checkov Findings" >> security_reports/all_findings.txt
          cat security_reports/checkov_report.txt >> security_reports/all_findings.txt
          
          # Run the AI analysis if API key is available
          if [ -n "$GEMINI_API_KEY" ] || [ -n "$GOOGLE_API_KEY" ]; then
            echo "Generating AI-powered security analysis..."
            
            # Use cat to debug file content
            echo "TFSec report content:"
            cat security_reports/tfsec_report.md | head -20
            echo "Checkov report content:"
            cat security_reports/checkov_report.txt | head -20
            
            # Run gemini_security_analyzer with proper paths
            python3 ../scripts/gemini_security_analyzer.py \
              --tfsec-report="security_reports/tfsec_report.md" \
              --checkov-report="security_reports/checkov_report.txt" \
              --tf-directory="." \
              --output="security_reports/AI_SECURITY_ANALYSIS.md"
            
            # Check if analysis was generated successfully
            if [ -f "security_reports/AI_SECURITY_ANALYSIS.md" ] && [ -s "security_reports/AI_SECURITY_ANALYSIS.md" ]; then
              echo "AI security analysis generated successfully"
              # Print first few lines of the analysis for verification
              echo "First few lines of AI analysis:"
              head -10 security_reports/AI_SECURITY_ANALYSIS.md
            else
              echo "Failed to generate AI security analysis or file is empty"
              # Create a fallback analysis file with basic recommendations
              cat > security_reports/AI_SECURITY_ANALYSIS.md << EOF
# AI Security Analysis

*Note: The automatic AI analysis could not be generated. Here are some general security recommendations:*

## General Security Best Practices

1. **Use IAM roles with least privilege access**
   - Restrict permissions to only what is necessary
   - Regularly review and audit permissions

2. **Encrypt sensitive data**
   - Use AWS KMS for managing encryption keys
   - Enable encryption at rest for all data stores
   - Enable encryption in transit

3. **Network Security**
   - Use security groups with restrictive inbound/outbound rules
   - Implement network ACLs for additional security
   - Use private subnets for sensitive resources

4. **Logging and Monitoring**
   - Enable CloudTrail for API logging
   - Set up CloudWatch alarms for suspicious activities
   - Implement centralized logging

5. **Resource Configuration**
   - Disable public access where not needed
   - Use secure TLS versions
   - Keep software and dependencies updated
EOF
            fi
          else
            echo "Skipping AI analysis - No Gemini API key found"
            # Create a notice file
            echo "# AI Security Analysis Unavailable\n\nAI-powered security analysis was skipped because no Gemini API key was provided." > security_reports/AI_SECURITY_ANALYSIS.md
          fi

      - name: Create Pull Request
        if: steps.find_tf.outputs.tf_found == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.REPO_PAT }}
          path: target_repo
          commit-message: "Add Infrastructure Security Scan Report"
          title: "ðŸ”’ Security Scan: Infrastructure Security Report"
          body: |
            # ðŸ”’ Infrastructure Security Scan
            
            This PR adds a security scan report for your Terraform infrastructure.
            
            ## Summary
            - **TFSec Issues**: ${{ steps.tfsec.outputs.tfsec_issues || '0' }}
            - **Checkov Issues**: ${{ steps.checkov.outputs.checkov_issues || '0' }}
            
            ## What's included
            - Comprehensive security scan report
            - Issues identified with their severity levels
            - Recommendations for improving security
            - AI-powered security analysis with actionable advice
            
            Please review the `security_reports/SECURITY_REPORT.md` and `security_reports/AI_SECURITY_ANALYSIS.md` files for detailed information.
          branch: "inframate/security-scan"
          base: ${{ github.event.inputs.target_branch }}
      
      - name: Upload Security Reports
        if: steps.find_tf.outputs.tf_found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: target_repo/security_reports/
          retention-days: 7 